let s=[],o=null,g=!1,i=null;const E="https://localhost:7298";document.addEventListener("DOMContentLoaded",function(){setTimeout(()=>{if(window.requireAuth()){if(i=window.getCurrentUserId(),!i){console.error("No se pudo obtener el ID del usuario autenticado"),setTimeout(()=>{i=window.getCurrentUserId(),i?(console.log("Usuario autenticado (segundo intento), ID:",i),y()):(console.error("Aún no se puede obtener el ID del usuario, redirigiendo..."),window.location.href="/login")},1e3);return}console.log("Usuario autenticado, ID:",i),y()}},500)});async function y(){try{const t=await(await fetch(`${E}/api/configuracion/obtener/${i}`)).json();t.success&&t.data?(s=Array.isArray(t.data)?t.data:[t.data],s=s.filter(n=>n.accionResumen==="email"),h()):p("No se encontraron configuraciones disponibles")}catch(e){console.error("Error al cargar configuraciones:",e),p("Error al cargar configuraciones")}}function h(){const e=document.getElementById("select-configuracion-simulador");if(e.innerHTML='<option value="">Seleccionar configuración...</option>',s.length===0){e.innerHTML='<option value="">No hay configuraciones de email disponibles</option>';return}s.forEach(t=>{const n=document.createElement("option");n.value=t.id,n.textContent=`Configuración ${t.id} - ${t.hashtags||"Sin hashtags"}`,e.appendChild(n)})}window.mostrarConfiguracionSeleccionada=function(e){const t=document.getElementById("configuracion-preview");if(!e){t.style.display="none",o=null;return}o=s.find(n=>n.id==e),o?(document.getElementById("preview-hashtags").textContent=o.hashtags||"No especificados",document.getElementById("preview-profundidad").textContent=o.profundidadResumen||"No especificada",document.getElementById("preview-tono").textContent=o.tonoResumen||"No especificado",document.getElementById("preview-accion").textContent=o.accionResumen||"No especificada",t.style.display="block"):t.style.display="none"};function r(e,t="info"){const n=document.getElementById("log-contenido"),u=new Date().toLocaleTimeString(),c=t==="error"?"text-red-600":t==="success"?"text-green-600":"text-gray-600",d=document.createElement("div");d.className=c,d.textContent=`[${u}] ${e}`,n.appendChild(d),n.scrollTop=n.scrollHeight}function m(e,t){document.getElementById("barra-progreso").style.width=`${e}%`,document.getElementById("progreso-texto").textContent=`${e}%`,document.getElementById("paso-actual").textContent=t}function p(e){document.getElementById("error-mensaje").textContent=e,document.getElementById("resultado-error").classList.remove("hidden"),document.getElementById("resultado-final").classList.add("hidden")}window.reiniciarSimulacion=function(){document.getElementById("area-resultados").classList.add("hidden"),document.getElementById("resultado-final").classList.add("hidden"),document.getElementById("resultado-error").classList.add("hidden"),document.getElementById("form-simulador").reset(),document.getElementById("configuracion-preview").style.display="none",document.getElementById("btn-comenzar").disabled=!1,document.getElementById("log-contenido").innerHTML="",g=!1};async function w(e){const t=e.get("url_noticias"),n=e.get("configuracion_id"),u=e.get("enviar_email")==="on",c=parseInt(e.get("limite_noticias")),d=Date.now();try{m(10,"Validando URL..."),r("Iniciando validación de URL"),await new Promise(f=>setTimeout(f,1e3)),m(30,"Extrayendo noticias..."),r(`Extrayendo hasta ${c} noticias de: ${t}`),await new Promise(f=>setTimeout(f,2e3)),m(60,"Procesando con IA..."),r("Enviando noticias a Semantic Kernel para procesamiento");const a=await fetch(`${E}/api/simulador/procesar`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({urlNoticias:t,configuracionId:parseInt(n),limiteNoticias:c,enviarEmail:u})});if(!a.ok)throw new Error(`Error del servidor: ${a.status}`);const l=await a.json();m(100,"Completado"),r("Simulación completada exitosamente","success");const I=((Date.now()-d)/1e3).toFixed(1);document.getElementById("resumen-contenido").textContent=l.resumen||"Resumen generado exitosamente",document.getElementById("stat-noticias").textContent=l.noticiasProcessadas||c,document.getElementById("stat-tiempo").textContent=`${I}s`,document.getElementById("stat-palabras").textContent=l.resumen?l.resumen.split(" ").length:"0",u&&l.emailEnviado&&r("Email enviado exitosamente","success"),document.getElementById("resultado-final").classList.remove("hidden")}catch(a){console.error("Error en simulación:",a),r(`Error: ${a.message}`,"error"),p(a.message)}}document.getElementById("form-simulador").addEventListener("submit",async function(e){if(e.preventDefault(),g)return;const t=new FormData(e.target);if(!o){alert("Por favor selecciona una configuración");return}g=!0,document.getElementById("btn-comenzar").disabled=!0,document.getElementById("area-resultados").classList.remove("hidden"),document.getElementById("resultado-final").classList.add("hidden"),document.getElementById("resultado-error").classList.add("hidden"),await w(t),g=!1,document.getElementById("btn-comenzar").disabled=!1});
