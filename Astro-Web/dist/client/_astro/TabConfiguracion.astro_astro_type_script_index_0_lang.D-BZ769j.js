let s=null;document.addEventListener("DOMContentLoaded",()=>{console.log("Inicializando TabConfiguracion...");function t(a=5,e=1e3){return new Promise((n,o)=>{let r=0;function i(){if(r++,console.log(`Intento ${r} de obtener usuario autenticado...`),typeof window.getCurrentUserId!="function")if(console.log("Funciones de auth aún no disponibles..."),r<a){setTimeout(i,e);return}else{o(new Error("Funciones de autenticación no disponibles"));return}s=window.getCurrentUserId(),s?(console.log(`suario autenticado obtenido: ${s}`),n(s)):(console.log("Usuario aún no disponible..."),r<a?setTimeout(i,e):o(new Error("No se pudo obtener el ID del usuario")))}i()})}t().then(a=>{s=a,console.log("Inicializando configuraciones con usuario:",s),window.location.search.includes("tab=configuracion")&&(new URLSearchParams(window.location.search).get("subtab")==="gestionar"&&c(),u(),l(),g(),m())}).catch(a=>{console.error("Error inicializando configuraciones:",a),window.location.href="/login"})});function u(){const t=document.getElementById("form-crear-configuracion");t&&t.addEventListener("submit",async a=>{a.preventDefault();const e=new FormData(a.target),n=[];document.querySelectorAll('input[name="dias"]:checked').forEach(i=>{n.push(i.value)});const r={usuarioId:s,hashtags:e.get("hashtags"),profundidadResumen:e.get("profundidad"),tonoResumen:e.get("tono"),accionResumen:e.get("output"),frecuencia:e.get("frecuencia")||"diaria",horaEnvio:e.get("horaEnvio")||"08:00",diasPersonalizados:n.length>0?n.join(","):"1,2,3,4,5"};try{const d=await(await fetch("https://localhost:7298/api/configuracion/crear",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)})).json();d.success?(alert("Configuración creada exitosamente"),a.target.reset(),window.location.search.includes("subtab=gestionar")&&c()):alert(" Error: "+d.message)}catch{alert("Error de conexión. Verifica que el backend esté ejecutándose.")}})}function l(){const t=document.getElementById("frecuencia-select");t&&t.addEventListener("change",function(){const a=document.getElementById("opciones-personalizada");this.value==="personalizada"?a.classList.remove("hidden"):a.classList.add("hidden")})}async function c(){const t=document.getElementById("lista-configuraciones");if(t){t.innerHTML='<div class="text-center text-gray-500">Cargando configuraciones...</div>';try{const e=await(await fetch(`https://localhost:7298/api/configuracion/obtener/${s}`)).json();if(e.success&&e.data){const n=Array.isArray(e.data)?e.data:[e.data];f(n)}else t.innerHTML='<div class="text-center text-gray-500">No hay configuraciones guardadas</div>'}catch(a){t.innerHTML='<div class="text-center text-red-500">Error al cargar configuraciones: '+a.message+"</div>"}}}function f(t){const a=document.getElementById("lista-configuraciones");if(!a||t.length===0){a.innerHTML='<div class="text-center text-gray-500">No hay configuraciones creadas</div>';return}a.innerHTML=t.map(e=>`
      <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 flex justify-between items-center">
        <div>
          <h3 class="font-medium">${e.hashtags||"Sin hashtags"}</h3>
          <p class="text-sm text-gray-600">
            ${e.profundidadResumen||"Breve"} • ${e.tonoResumen||"Informal"} • ${e.frecuencia||"Diaria"}
          </p>
          <p class="text-xs text-gray-500">
            ${e.accionResumen||"Email"} • ${e.activa?"Activa":"Pausada"}
          </p>
        </div>
        <div class="flex space-x-2">
          <button onclick="toggleConfiguracion(${e.id})" class="px-3 py-1 text-sm rounded-full border-2 ${e.activa?"bg-red-100 text-red-700 border-red-300":"bg-green-100 text-green-700 border-green-300"}">
            ${e.activa?"Pausar":"Reanudar"}
          </button>
          <button onclick="abrirModalEditar(${e.id})" class="px-3 py-1 text-sm bg-blue-100 text-blue-700 rounded-full border-2 border-blue-300">
            Editar
          </button>
        </div>
      </div>
    `).join("")}function g(){const t=document.getElementById("form-editar-configuracion");t&&t.addEventListener("submit",async a=>{a.preventDefault();const e=new FormData(a.target),n=[];document.querySelectorAll('input[name="dias-modal"]:checked').forEach(i=>{n.push(i.value)});const r={id:parseInt(e.get("configId")),hashtags:e.get("hashtags"),profundidadResumen:e.get("profundidad"),tonoResumen:e.get("tono"),accionResumen:e.get("output"),frecuencia:e.get("frecuencia"),horaEnvio:e.get("horaEnvio"),diasPersonalizados:n.length>0?n.join(","):"1,2,3,4,5"};try{const d=await(await fetch("https://localhost:7298/api/configuracion/actualizar",{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)})).json();d.success?(alert(" Configuración actualizada exitosamente"),window.cerrarModalConfig(),c()):alert(" Error: "+d.message)}catch{alert("Error de conexión. Verifica que el backend esté ejecutándose.")}})}function m(){const t=document.getElementById("pausar-todas"),a=document.getElementById("reanudar-todas");t&&t.addEventListener("click",async()=>{if(confirm("¿Pausar TODAS las configuraciones?"))try{const n=await(await fetch(`https://localhost:7298/api/configuracion/obtener/${s}`)).json();if(n.success&&n.data){const r=(Array.isArray(n.data)?n.data:[n.data]).filter(i=>i.activa);for(const i of r)await fetch(`https://localhost:7298/api/configuracion/pausar/${i.id}`,{method:"PUT",headers:{"Content-Type":"application/json"}});alert(`${r.length} configuraciones pausadas`),c()}}catch{alert("Error al pausar configuraciones")}}),a&&a.addEventListener("click",async()=>{if(confirm("¿Reanudar TODAS las configuraciones?"))try{const n=await(await fetch(`https://localhost:7298/api/configuracion/obtener/${s}`)).json();if(n.success&&n.data){const r=(Array.isArray(n.data)?n.data:[n.data]).filter(i=>!i.activa);for(const i of r)await fetch(`https://localhost:7298/api/configuracion/reanudar/${i.id}`,{method:"PUT",headers:{"Content-Type":"application/json"}});alert(`${r.length} configuraciones reanudadas`),c()}}catch{alert("Error al reanudar configuraciones")}})}window.toggleConfiguracion=async t=>{try{const e=await(await fetch(`https://localhost:7298/api/configuracion/obtener/${s}`)).json();if(e.success&&e.data){const o=(Array.isArray(e.data)?e.data:[e.data]).find(r=>r.id===t);if(o){const r=o.activa?`https://localhost:7298/api/configuracion/pausar/${t}`:`https://localhost:7298/api/configuracion/reanudar/${t}`;(await fetch(r,{method:"PUT",headers:{"Content-Type":"application/json"}})).ok?(alert(o.activa?"Configuración pausada":"Configuración reanudada"),c()):alert("Error al cambiar estado")}}}catch(a){alert("Error de conexión: "+a.message)}};window.abrirModalEditar=async t=>{try{const e=await(await fetch(`https://localhost:7298/api/configuracion/obtener/${s}`)).json();if(e.success&&e.data){const o=(Array.isArray(e.data)?e.data:[e.data]).find(r=>r.id===t);o&&(document.getElementById("modal-hashtags-actual").textContent=o.hashtags||"No especificados",document.getElementById("modal-profundidad-actual").textContent=o.profundidadResumen||"No especificada",document.getElementById("modal-tono-actual").textContent=o.tonoResumen||"No especificado",document.getElementById("modal-frecuencia-actual").textContent=o.frecuencia||"diaria",document.getElementById("modal-tipo-actual").textContent=o.accionResumen||"No especificada",document.getElementById("modal-config-id").value=o.id,document.getElementById("modal-hashtags-edit").value=o.hashtags||"",document.getElementById("modal-profundidad-edit").value=o.profundidadResumen||"breve",document.getElementById("modal-tono-edit").value=o.tonoResumen||"neutral",document.getElementById("modal-frecuencia-edit").value=o.frecuencia||"diaria",document.getElementById("modal-hora-edit").value=o.horaEnvio||"08:00",document.querySelectorAll('input[name="output"]').forEach(i=>{i.checked=i.value===o.accionResumen}),document.getElementById("modal-editar-config").classList.remove("hidden"))}}catch{alert("Error al cargar los datos de la configuración")}};window.cerrarModalConfig=()=>{document.getElementById("modal-editar-config").classList.add("hidden")};window.manejarCambioFrecuenciaModal=t=>{const a=document.getElementById("modal-opciones-personalizada");t==="personalizada"?a.classList.remove("hidden"):a.classList.add("hidden")};
